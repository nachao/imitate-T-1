<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=no">
		<title>Document</title>
		<link rel="stylesheet" type="text/css" href="./css/bootstrap.css" />
		<script type="text/javascript" src="./js/vue.js"></script>
		<script type="text/javascript" src="./js/jquery.js"></script>
		<script type="text/javascript" src="./js/bootstrap.js"></script>
		<style type="text/css">
			
			.length-of-days {
				display: inline-block;
			}
			.length-of-days i {
				display: inline-block;
				width: 33px;
				height: 33px;
				line-height: 33px;
				border-radius: 3px;
				background: #aaa;
				float: left;
				margin: 0 10px 10px 0;
				text-align: center;
				color: #eee;
				cursor: pointer;
			}
			.length-of-days i:hover {
				background: #888;
			}
			.length-of-days i.act {
				background: orange;
			}

			.form-control {
				display: initial;
				width: 100px;
				height: initial;
				border-radius: 0px;
				padding: 2px 10px;
			}

			.history-list .history-item {
				display: inline-block;
				float: left;
				border-radius: 3px;
				background: #90a4ae;
				color: white;
				padding: 10px;
				margin: 0 10px 10px 0;
			}

			.total-text { 
				border: 0px;
				border-bottom: 1px solid #aaa;
				outline: none;
			}

		</style>
	</head>

		<div class="container">
			<h3>
				<span>Total: </span>
				<span v-text="getFixed(total + income)" ></span>
			</h3>
			<ul class="list-inline">
				<li>
					<span>Usable: </span>
					<b v-text="getFixed(income)"></b>
				</li>
				<li>
					<span>Income: </span>
					<b v-text="getFixed(income)"></b>
					<small><i v-text="'(' + getFixed(income/total) + '%)'"></i></small>
				</li>
				<li>
					<span>Days: </span>
					<b v-text="days"></b>
					<small><i v-text="'(' + getInt(days/22) + 'months)'"></i></small>
				</li>
			</ul>
			<hr>

			<div class="alert" :class="{ 'alert-success': !trends, 'alert-danger': trends }" role="alert">
				<ul class="list-inline">
					<li>
						<b v-text="market.code"></b>
					</li>
					<li>
						<span v-text="market.name"></span>
					</li>
					<li>
						<i v-text="getFixed(market.price)"></i>
						<i v-text="'(' + yield + ')'"></i>
					</li>
					<li class="pull-right">
						<b v-text="market.hold"></b>
					</li>
				</ul>
			</div>
			<hr />

			<div>
				<h3>Spend</h3>
				<div class="length-of-days" >
					<i v-for="key in 10" v-text="key+1"
						v-bind:class="{ 'act' :key < spend }" 
						@click="spend = key+1" >
					</i>
				</div>
				<form @submit.prevent="setToday">
					<div class="form-group">
						<input type="text" v-model="price"  placeholder="price" class="form-control" />
						<span class="pull-right">
							<input type="button" value="+" 
								@click="setAddPrice" 
								@mousedown="setLastStart('setAddPrice')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd" />
							<input type="button" value="-" 
								@click="setSubPrice"
								@mousedown="setLastStart('setSubPrice')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd" />
							<input type="submit" value="Update" />
						</span>
					</div>
				</form>
			</div>
			<hr/>

			<div>
				<h3>Buy</h3>
				<form class="form" @submit.prevent="setBuy">
					<div class="form-group">
						<input v-model="number" placeholder="number" class="form-control" />
						<span class="pull-right">
							<input type="button" value="+" @click="setAddHold"
								@mousedown="setLastStart('setAddHold')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd" />
							<input type="button" value="-" @click="setSubHold"
								@mousedown="setLastStart('setSubHold')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd"/>
							<input type="button" value="50%" @click="number = getInt(toplimit/2)" />
							<input type="button" value="100%" @click="number = toplimit" />
							<input type="submit" value="Buy" />
						</span>
					</div>
				</form>
				<ul class="list-inline">
					<li>
						<small>Open positions: </small>
						<b v-text="toplimit"></b>
					</li>
					<li>
						<small>Need to pay: </small>
						<b v-text="getFixed(number * price * 100)"></b>
					</li>
				</ul>
			</div>
			<hr/>

			<div v-if="existOwned">
				<h3>Owned</h3>
				<div v-for="item in business" v-if="item.have" class="alert alert-warning" role="alert" >
					<ul class="list-inline">
						<li>
							<!-- <small>price: </small> -->
							<b v-text="item.price"></b>
						</li>
						<li>
							<!-- <small>hold: </small> -->
							<span v-text="item.number"></span>
							<i v-text="'('+ getYield(item) +')'"></i>=
							<span v-text="getProfit(item)"></span>
						</li>
						<!-- <li>
							<small>income: </small>
						</li> -->
						<li v-if="item.days < days" class="pull-right">
							<a href="javascript:;" @click="sold = item" >Sold</a>
						</li>
					</ul>
					<div v-if="sold && item.key == sold.key">
						<hr/>
						<h3>Sold</h3>
						<form class="form" @submit.prevent="setSold">
							<div class="form-group" >
								<input v-model="offtake" placeholder="offtake" class="form-control" />*100
								<span class="pull-right">
									<input type="button" value="+" @click="setAddOfftake"
										@mousedown="setLastStart('setAddOfftake')" 
										@mouseup="setLastEnd"
										@mouseleave="setLastEnd" />
									<input type="button" value="-" @click="setSubOfftake"
										@mousedown="setLastStart('setSubOfftake')" 
										@mouseup="setLastEnd"
										@mouseleave="setLastEnd" />
									<input type="button" value="100%" @click="offtake = sold.number /100"/>
									<input type="submit" value="Sold" />
								</span>
							</div>
						</form>
					</div>
				</div>
				<hr/>
			</div>

			<div v-if="business.length">
				<h3>History</h3>
				<div class="history-list">
					<span class="history-item" v-for="item in business" v-if="$index > business.length - 22" >
						<span v-text="item.days"></span>
						<span v-text="item.type"></span><br/>
						<ins v-if="item.type == 'B'" v-text="item.price"></ins>
						<template v-if="item.type == 'S'">
							<ins v-text="item.sell"></ins>
							<small v-text="getIncome(item.price, item.sell, item.number/100)"></small>
							<small v-text="'('+getYield(item.price, item.sell, item.number/100)+')'"></small>
						</template>
					</span>
				</div>
				<div class="clearfix"></div>
				<hr/>
			</div>

			<div v-if="monthYield">
				<h3>Yield</h3>
				<div class="">
					<p><span>Year: </span>{{ monthYield.year.length ? monthYield.year : '-' }}</p>
					<p><span>Month: </span>{{ monthYield.month.length ? monthYield.month : '-' }}</p>
					<p><span>Standardizedrate: </span>{{ monthYield.standardizedrate || '-' }}</p>
				</div>
				<hr/>
			</div>

			<div>
				<h3>Seting</h3>
				<template  v-if="intercalate">
					<p>
						<span>setting total: </span>
						<span v-text="total"></span>
						<span class="pull-right">
							<a href="javascript:;" @click="total+=1000" >+1000</a>
							<a href="javascript:;" @click="total+=5000" >+5000</a>
							<a href="javascript:;" @click="total-=1000">-1000</a>
							<a href="javascript:;" @click="total-=5000">-5000</a>
						</span>
					</p>
					<p>
						<span>auto imitate: </span>
						<span class="pull-right">
							<a href="javascript:;" @click="setImitate" >gooo</a>
						</span>
					</p>
				</template>
				<p>
					<b><a href="javascript:;" @click="intercalate = !intercalate" >Set toggle</a></b>
				</p>
				<hr/>
			</div>

			<!-- <div class="">
				<h3>Requirement</h3>
				<p>1、显示每个月的收益率，以及收益总额。</p>
				<p>2、设置每个月的标准是22%的收益率，以及为了满足月。</p>
				<p>3、记录每个月的收益率到“简单数据”中，进行一年的模拟操作，推算出1一年中1%收益的年份的占比。如果大于则说明这个计划成立，如果小于则可以降低每月的收益率，因为如果按照1%的月收益率半年就可以获得500%。</p>

				<p>4、得出一个根据买入价和手续费得出1%净收益的卖出价的一个公式函数。</p>
				<p>5、尽快得出一个月的正常情况下的22天中的目标收益率的占比，进行至少12个月的模拟测试得出数据。在得出了月内目标收益率的占比后，需要根据占比重新计算日净收益率，始终确保月净收益率为22%。</p>

				<p>举例：如果一个月按照正常的22天计算，月目标收益占比为70%，那么如收益率则需要达到1.3%。公式：for(var a=10000,x=0.013,i=1;i<=12*(22*(0.7));i++){ a=a+a*x;console.log(a,a*x) }</p>

				<p>6、交易采用当天下午收盘时卖，然后根据情况再立即买。在现实操作中可以在休息是看盘到达预计净收益即可卖出，在此一定要确保，每天都在进行买入和卖出的操作。因此不管是早上卖出和买入都是可以的。</p>

				<p>7、真实情况下，对每天的收益额，每月的收益额，以及对应的收益率进行记录，包括总金额。公司可以自己做，为了以目标为导向有一个明确的系统。只要确保在计划的时间点完成了目标即可，要求不多不少。</p>
			</div> -->

		</div>

		<script type="text/javascript">


			new Vue({
				el: 'body',
				data: {
					total: 10000,
					income: 0,
					days: 0,

					market: {
						'code'	: '002469',
						'name'	: 'Chowns',
						'price'	: 8.58,
						'hold'	: 0
					},

					became: [],				// 每日金额变得
					business: [],			// 买入/卖出交易记录

					spend: 1,				// 过去天数

					price: 0,				// 单股的金额变动
					previous: 0,			// 单股的上次金额

					number: 1,				// 买入数量

					sold: null,
					offtake: 1,				// 卖出数量

					yield: '0%',			// 收益率
					trends: true,			// 趋势
					// harden: false,			// 涨停
					// limit: false,			// 跌停

					intercalate: false,

					imitate: 0,				// 模拟次数

					annualearnings: [],
					yields: [],

				},
				computed: {

					// 是否可以购买
					// canBuy: function () {
					// 	var number = (parseInt(this.number) || 0 ) * 100;
					// 	return this.total >= number * this.market.price;
					// },

					// 判断涨跌
					// trends: function () {
					// 	return Number(this.price) > Number(this.previous);
					// }

					// 持仓数量
					existOwned: function () {
						return this.business.filter(function( item ){
							return item.have;
						}).length;
					},

					// 交易历史
					existHistory: function () {
						return this.business.filter(function( item ){
							return !item.have;
						}).length;
					},

					// 持仓上限
					toplimit: function () {
						return parseInt(this.total / (this.market.price * 100));
					},

					// 计算收益率统计
					monthYield: function () {
						var arr = this.business.filter(function( item ){ return !item.have && item.type == 'S' }),
							length = parseInt(arr.length / 22);

						var standard = 0,
							temp = 0,
							sum;

						var	result = {
								month: [],
								year: [],
								standardizedrate: ''
							};

						// 年
						for ( var i=0; i<parseInt(arr.length / (22 * 12)); i++ ) {
							temp=0;
							arr.slice(i*(22*12), i*(22*12)+(22*12)).map(function( item ){
								temp += (item.sell - item.price) / item.price * 100;
								sum += 
							});
							// if ( temp > (22*12) ) {
							// 	standard += 1;
							// }
							result.year.push((temp/22).toFixed(2) + '%');
						}

						// 月
						for ( var i=0; i<length; i++ ) {
							temp=0;
							arr.slice(i*22, i*22+22).map(function( item ){
								temp += (item.sell - item.price) / item.price * 100;
							});
							if ( temp > 22 ) {
								standard += 1;
							}
							result.month.push({
								ratio: (temp/22).toFixed(2) + '%',
								value: 
							});
						}

						// 月标准率
						if ( standard ) {
							result.standardizedrate = (standard / result.month.length * 100).toFixed(2) + '%';
						}

						return result;
					}

				},
				watch: {

					// 计算日收益率
					previous: function () {
						this.yield = (( this.price - this.previous ) / this.price * 100).toFixed(2) + '%';

						this.trends = Number(this.price) > Number(this.previous);
						// this.harden = Number(this.price) > Number(this.previous);
						// this.limit = Number(this.price) < Number(this.previous);
					}
				},
				methods: {

					// 买入
					setBuy: function () {
						var number = (parseInt(this.number) || 0 ) * 100,
							money = number * this.market.price;

						if ( this.total >= money && money ) {
							this.total = Number((this.total - money).toFixed(2));
							this.market.hold += number;
							this.setBuyLog(number);

							this.number = 1;
						}
					},

					// 卖出
					setSold: function () {
						var b = this.sold.price,
							s = this.market.price,
							n = this.offtake;

						var number = this.offtake * 100;

						this.income = Number((this.income + this.getIncome(b,s,n)).toFixed(2));
						this.total = Number((this.total + this.getIncome(b,s,n,true)).toFixed(2));

						// 如果平仓 
						if ( this.sold.number == number ) {
							this.sold.have = false;
						}

						// 减仓
						this.market.hold -= number;
						this.sold.number -= number;

						// 记录
						this.setSoldLog(number);

						// 初始化
						this.sold = null;
						this.offtake = 0;
					},

					// 添加购买交易记录
					setBuyLog: function ( number ) {
						var isOpen = true,
							self = this;

						this.business.map(function( item ){
							if ( item.price == self.market.price && item.days == self.days && item.type == 'B' ) {
								item.number += number;
								isOpen = false;
							}
						});

						// 是否开仓
						if ( isOpen ) {
							this.business.push({
								'type'	: 'B',
								'key'	: new Date().getTime().toString(16),
								'have'	: true,
								'number': number,
								'price'	: this.market.price,
								'sell'	: 0,
								'days'	: this.days
							});
						}
					},

					// 添加卖出记录
					setSoldLog: function ( number ) {
						var isNew = true,
							self = this;

						this.business.map(function( item ){
							if ( item.days == self.days && item.type == 'S' ) {
								item.number += number;
								isNew = false;
							}
						});

						if ( isNew ) {
							this.business.push({
								'type'	: 'S',
								'key'	: new Date().getTime().toString(16),
								'have'	: false,
								'number': number,
								'price'	: this.sold.price,
								'sell'	: this.market.price,
								'days'	: this.days
							});
						}
					},

					// 收盘定价
					setToday: function () {
						var price = Number(this.price);

						this.previous = this.market.price;

						this.days += this.spend;
						this.market.price = price;

						this.became.push({
							'date'	: this.days,
							'price'	: this.market.price
						});
					},

					// 获取单笔收益率
					getYield : function ( item ) {
						return ((this.market.price - item.price) * item.price).toFixed(2) + '%';
					},

					// 获取单笔收益
					getProfit: function ( item ) {
						return ((this.market.price - item.price) * item.number).toFixed(2);
					},

					// 加庄 减庄
					setAddPrice: function () {
						this.price = (Number(this.price) + 0.01).toFixed(2);
					},
					setSubPrice: function () {
						this.price = (Number(this.price) - 0.01).toFixed(2);
					},

					// 加仓 减仓
					setAddHold: function () {
						this.number = Number(this.number) + 1 > parseInt(this.total / (this.market.price * 100)) ? Number(this.number) : Number(this.number) + 1;
					},
					setSubHold: function () {
						this.number = Number(this.number) - 1 < 0 ? 0 : Number(this.number) - 1;
					},

					// 加减 卖出 
					setAddOfftake: function () {
						this.offtake = Number(this.offtake) + 1 > this.sold.number / 100 ? this.offtake : Number(this.offtake) + 1;
					},
					setSubOfftake: function () {
						this.offtake = Number(this.offtake) - 1 < 0 ? 0 : Number(this.offtake) - 1;
					},

					// 持续
					setLastStart: function ( key ) {
						var self = this;

						window.t = setTimeout(function(){
							self.setLastStart(key);
							if ( self[key] ) {
								self[key]();
							}
						}, window.t ? 100 : 500);
					},
					setLastEnd: function () {
						clearTimeout(window.t);
					},

					// 获取净收益总额
					getIncome: function ( b=1, s=10, n=1, t=false ) {
						if ( n === true ) {
							t = n; n = 1
						};
						return Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );
					},

					// 获取净收益率
					getYield: function ( b=1, s=10, n=1, t=false ) {
						if ( n === true ) {
							t = n; n = 1
						};
						var income = Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );

						return this.getFixed(income / (b*n*100) * 100) + '%';
					},

					// 获取两位小数
					getFixed: function ( value ) {
						return Number(value || 0).toFixed(2);
					},

					// 取整数
					getInt: function ( value ) {
						return parseInt(value) || 0;
					},

					// 模拟交易
					setImitate: function () {
						var change = parseInt(Math.random()*100)+1 <= 75,			// 几率
							random = Number(Number( (Math.random()*10).toFixed(2) / 100 )).toFixed(2);

						random = 0.001 + (parseInt((Math.random()*33)) / 1000);

						var value = Number(this.price * random) || 0;

						// 价格
						if ( change ) {
							this.price = (Number(this.price) + value).toFixed(2);
						}
						else {
							this.price = (Number(this.price) - value).toFixed(2);
						}
						this.setToday();

						// 卖出
						if ( this.existOwned ) {
							for ( var i=0, item; item = this.business[i]; i++ ) {
								if ( item.have ) {
									this.offtake = item.number / 100;
									this.sold = item;
									break;
								}
							}
							if ( this.sold ) {
								this.setSold();
							}
						}

						// 存入
						if ( this.business % 22 == 0 ) {
							this.total += 1000;
						}

						if ( this.imitate < 22 * 12 ) {	// 22 * 12

							// 买入
							this.number = this.toplimit;
							this.setBuy();

							this.imitate += 1;
							setTimeout(this.setImitate, 10);
						}
						else {
							// var self = this;
							// window.annualearnings = this.annualearnings.push(this.total + this.income);
							// setTimeout(function(){
							// 	self.total = 10000;
							// 	self.income = 0;
							// 	self.price = 8.58;
							// 	self.business = [];
							// 	self.became = [];
							// 	self.spend = 1;
							// 	self.number = 1;
							// 	self.offtake = 1;
							// 	self.days = 1;
							// 	self.imitate = 0
							// 	self.setImitate();
							// }, 3000);
						}
					}

					// 获取收益率
					// getYield: function () {
					// 	return (( this.price - this.previous ) / this.price * 100).toFixed(2) + '%';
					// }
				},
				ready: function () {
					this.price = this.market.price;
					this.previous = this.market.price;

					// this.setImitate();
				}
			});


			

			// 获取收益
			// var income = function ( b=1, s=10, n=1, t=false ) {
			// 		if ( n === true ) {
			// 			t = n; n = 1
			// 		};
			// 		return Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );
			// 	};
			// var value = 10000;
			// for ( var i =0; i<12; i++ ) {
			// 	console.log( (i+1) + '月-----------------------');
			// 	console.log( '本金：' + value, '收益：' + parseInt(value*0.3), '总金额：' + (value += parseInt(value * 0.3)) );
			// }

			// 日净收益为1%，每月净收益22%，计算出年净收益率：1000%。
			// for(var a=10000,x=0.22,i=1;i<=12;i++){ a=a+a*x }

		</script>
	</body>
</html>