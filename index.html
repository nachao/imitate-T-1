<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=no">
		<title>Document</title>
		<link rel="stylesheet" type="text/css" href="./css/bootstrap.css" />
		<script type="text/javascript" src="./js/vue.js"></script>
		<script type="text/javascript" src="./js/jquery.js"></script>
		<script type="text/javascript" src="./js/bootstrap.js"></script>
		<script type="text/javascript" src="http://cdn.bootcss.com/echarts/3.2.3/echarts.common.js"></script>
		<style type="text/css">
			
			.length-of-days {
				display: inline-block;
			}
			.length-of-days i {
				display: inline-block;
				width: 33px;
				height: 33px;
				line-height: 33px;
				border-radius: 3px;
				background: #aaa;
				float: left;
				margin: 0 10px 10px 0;
				text-align: center;
				color: #eee;
				cursor: pointer;
			}
			.length-of-days i:hover {
				background: #888;
			}
			.length-of-days i.act {
				background: orange;
			}

			.form-control {
				display: initial;
				width: 100px;
				height: initial;
				/*border-radius: 0px;
				padding: 2px 10px;*/
			}

			.history-list .history-item {
				display: inline-block;
				float: left;
				border-radius: 3px;
				background: #90a4ae;
				color: white;
				padding: 10px;
				margin: 0 10px 10px 0;
			}

			.total-text { 
				border: 0px;
				border-bottom: 1px solid #aaa;
				outline: none;
			}

		</style>
	</head>

		<div class="container">
			<h3>
				<span>Total: </span>
				<span v-text="total" ></span>
			</h3>
			<ul class="list-inline">
				<li>
					<span>Usable: </span>
					<b v-text="getFixed(usable)"></b>
				</li>
				<li>
					<span>Income: </span>
					<b v-text="getFixed(income)"></b>
					<!-- <small><i v-text="'(' + getFixed(income/usable) + '%)'"></i></small> -->
				</li>
				<li>
					<span>Days: </span>
					<b v-text="days"></b>
					<small><i v-text="'(' + getInt(days/22) + 'M.)'"></i></small>
				</li>
			</ul>
			<hr>

			<div class="alert" :class="{ 'alert-success': !trends, 'alert-danger': trends }" role="alert">
				<ul class="list-inline">
					<li>
						<b v-text="market.code"></b>
					</li>
					<li>
						<span v-text="market.name"></span>
					</li>
					<li>
						<i v-text="getFixed(market.price)"></i>
						<i v-text="'(' + yield + ')'"></i>
					</li>
					<!-- <li class="pull-right">
						<b v-text="market.hold"></b>
					</li> -->
				</ul>
			</div>
			<hr />

			<div>
				<h3>Spend</h3>
				<div class="length-of-days" >
					<i v-for="key in 6" v-text="key"
						v-bind:class="{ 'act' :key <= spend }" 
						@click="spend = key" >
					</i>
				</div>
				<form @submit.prevent="setToday">
					<div class="form-group">
						<input type="text" v-model="price"  placeholder="price" class="form-control" />
						<span class="pull-right">
							<input class="btn btn-default" type="button" value="   +   " 
								@click="setAddPrice" 
								@mousedown="setLastStart('setAddPrice')" 
								@mouseup="setLastEnd" />
							<input class="btn btn-default" type="button" value="   -   " 
								@click="setSubPrice"
								@mousedown="setLastStart('setSubPrice')" 
								@mouseup="setLastEnd" />
							<input class="btn btn-default" type="submit" value="Update" />
						</span>
					</div>
				</form>
			</div>
			<hr/>

			<div>
				<h3>Buy</h3>
				<form class="form" @submit.prevent="setBuy">
					<div class="form-group">
						<input v-model="number" placeholder="number" class="form-control" />
						<span class="pull-right">
							<!-- <input type="button" value="+" @click="setAddHold"
								@mousedown="setLastStart('setAddHold')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd" />
							<input type="button" value="-" @click="setSubHold"
								@mousedown="setLastStart('setSubHold')" 
								@mouseup="setLastEnd"
								@mouseleave="setLastEnd"/> -->
							<input class="btn btn-default" type="button" value="50%" @click="number = getInt(toplimit/2)" />
							<input class="btn btn-default" type="button" value="100%" @click="number = toplimit" />
							<input class="btn btn-default" type="submit" value="Buy" />
						</span>
					</div>
				</form>
			</div>
			<hr/>

			<div v-if="existOwned || entrustOwned">
				<h3>Transaction</h3>
				<div v-for="item in business" v-if="item.have && item.number > 0" class="alert alert-warning" role="alert" >
					<ul class="list-inline">
						<li>
							<b>Hold</b>
							<span v-text="item.price"></span>
						</li>
						<li class="pull-right">
							<a href="javascript:;" @click="getEntrust(item)" >Entrust</a>
							<a href="javascript:;" @click="getSold(item)" v-if="item.days < days" >&nbsp;&nbsp;&nbsp;Sold</a>
						</li>
					</ul>
					<ul class="list-inline">
						<li title="Current income">
							<span>CI=</span>
							<small v-text="getProfit(item)"></small>
							<small v-text="'(' + getYield(item) + ')'"></small>
						</li>
						<li title="Holding quantity ">
							<span>HQ=</span>
							<small v-text="item.number"></small>
						</li>
					</ul>
					<div v-if="entrust && item.key == entrust.key">
						<hr/>
						<h3>Entrust</h3>
						<form class="form-horizontal" @submit.prevent="setEntrust">
							<div class="form-group row" >
								<label class="col-sm-4 control-label">
									<span>Entrust price - </span>
									<small title="Recommended price" v-text="'RP'+ getSuggestedPrice(item)"></small>
									<small v-text="'('+ getSuggestedPoints(item) +'+)'"></small>
								</label>
								<div class="col-sm-8">
									<input v-model="entrustPrice" placeholder="price" class="form-control" disabled="true" />
									<span class="pull-right">
										<!-- <input type="button" value="+" @click="setAddEntrustPrice"
											@mousedown="setLastStart('setAddEntrustPrice')" 
											@mouseup="setLastEnd" />
										<input type="button" value="-" @click="setSubEntrustPrice"
											@mousedown="setLastStart('setSubEntrustPrice')" 
											@mouseup="setLastEnd" /> -->
										<input class="btn btn-default" type="button" value="x1" @click="setSuggestedPoints(item)"/>
										<input class="btn btn-default" type="button" value="x2" @click="setSuggestedPoints(item, 2)"/>
									</span>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="form-group row" >
								<label class="col-sm-4 control-label">Entrust number</label>
								<div class="col-sm-8">
									<input v-model="entrustNumber" placeholder="number" class="form-control" disabled="true" />*100
									<span class="pull-right">
										<!-- <input type="button" value="+" @click="setAddEntrustNumber"
											@mousedown="setLastStart('setAddEntrustNumber')" 
											@mouseup="setLastEnd"
											@mouseleave="setLastEnd" />
										<input type="button" value="-" @click="setSubEntrustNumber"
											@mousedown="setLastStart('setSubEntrustNumber')" 
											@mouseup="setLastEnd"
											@mouseleave="setLastEnd" /> -->
										<input class="btn btn-default" type="button" value="50%" @click="entrustNumber = getInt(entrust.number /200)"/>
										<input class="btn btn-default" type="button" value="100%" @click="entrustNumber = entrust.number /100"/>
									</span>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="form-group row" >
								<div class="col-sm-12">
									<span class="pull-right">
										<input class="btn btn-default" type="button" value="Close" @click="entrust = null"/>
										<input class="btn btn-success" type="submit" value="Entrust" />
									</span>
									<div class="clearfix"></div>
								</div>
							</div>
						</form>
					</div>
					<div v-if="sold && item.key == sold.key">
						<hr/>
						<h3>Sold</h3>
						<form class="form-horizontal" @submit.prevent="setSold">
							<div class="form-group row" >
								<label class="col-sm-4 control-label">
									<span>Sell quantity</span>
								</label>
								<div class="col-sm-8">
									<input v-model="offtake" placeholder="offtake" class="form-control" disabled="true" />*100
									<span class="pull-right">
										<!-- <input type="button" value="+" @click="setAddOfftake"
											@mousedown="setLastStart('setAddOfftake')" 
											@mouseup="setLastEnd"
											@mouseleave="setLastEnd" />
										<input type="button" value="-" @click="setSubOfftake"
											@mousedown="setLastStart('setSubOfftake')" 
											@mouseup="setLastEnd"
											@mouseleave="setLastEnd" /> -->
										<input class="btn btn-default" type="button" value="50%" @click="offtake = sold.number /200"/>
										<input class="btn btn-default" type="button" value="100%" @click="offtake = sold.number /100"/>
									</span>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="form-group row" >
								<div class="col-sm-12">
									<span class="pull-right">
										<input class="btn btn-default" type="button" value="Close" @click="sold = null"/>
										<input class="btn btn-success" type="submit" value="Sold" />
									</span>
									<div class="clearfix"></div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div v-for="item in entrustList" v-if="item.status" class="alert alert-success" role="alert" >
					<ul class="list-inline">
						<li>
							<b>Entr.</b>
							<span v-text="item.price"></span>
							<small v-text="'('+ item.sold.price +')'"></small>
						</li>
						<li class="pull-right">
							<a href="javascript:;" @click="setCancelEntrust(item)" >Cancel</a>
						</li>
					</ul>
					<ul class="list-inline">
						<li title="Anticipated revenue">
							<span>AR=</span>
							<small v-text="getEntrustProfit(item)"></small>
							<small v-text="'(' + getEntrustYield(item) + ')'"></small>
						</li>
						<li title="Entrust number">
							<span>EN=</span>
							<small v-text="item.offtake * 100"></small>
						</li>
					</ul>
				</div>
				<hr/>
			</div>

			<div v-if="monthYield">
				<h3>Statistics</h3>
				<ul class="list-inline">
					<li>
						<small>Day rate of return(Clean): </small>
						<b v-text="monthYield.dayRateOfReturn"></b>
					</li>
					<li>
						<small>Total Income ratio: </small>
						<b v-text="monthYield.dayIncomeRatio"></b>
					</li>
					<li>
						<small>Total profit(Clean): </small>
						<b v-text="getFixed(totalProfitAndLoss.profit)"></b>
					</li>
					<li>
						<small>Total loss(Clean): </small>
						<b v-text="getFixed(totalProfitAndLoss.loss)"></b>
					</li>
				</ul>
			    <div id="echartsEl" style="width: 100%;height:300px;"></div>
				<hr/>
			</div>

			<div v-if="business.length">
				<h3>History(Clean)</h3>
				<div class="history-list">
					<span class="history-item" v-for="item in business" v-if="$index > business.length - 22" >
						<b v-text="item.days"></b>
						<small v-text="item.type"></small>
						<small v-if="item.type == 'B'" v-text="item.price"></small>
						<template v-if="item.type == 'S'">
							<small v-text="item.sell"></small>
							<span v-text="getCleanYield(item)"></span>
							<!-- <small v-text="'('+ getCleanProfit(item) +'%)'"></small> -->
						</template>
					</span>
				</div>
				<div class="clearfix"></div>
				<hr/>
			</div>

			<div>
				<h3>Seting</h3>
				<template v-if="intercalate">
					<p>
						<span>setting usable: </span>
						<span v-text="usable"></span>
						<span class="pull-right">
							<a href="javascript:;" @click="usable+=1000" >+1000</a>
							<a href="javascript:;" @click="usable+=5000" >+5000</a>
							<a href="javascript:;" @click="usable-=1000">-1000</a>
							<a href="javascript:;" @click="usable-=5000">-5000</a>
						</span>
					</p>
					<p>
						<span>auto imitate: </span>
						<span class="pull-right">
							<a href="javascript:;" @click="setImitate" >gooo</a>
						</span>
					</p>
				</template>
				<p>
					<b><a href="javascript:;" @click="intercalate = !intercalate" >Set toggle</a></b>
				</p>
				<hr/>
			</div>

			<!-- <div class="">
				<h3>Requirement</h3>
				<p>1、显示每个月的收益率，以及收益总额。</p>
				<p>2、设置每个月的标准是22%的收益率，以及为了满足月。</p>
				<p>3、记录每个月的收益率到“简单数据”中，进行一年的模拟操作，推算出1一年中1%收益的年份的占比。如果大于则说明这个计划成立，如果小于则可以降低每月的收益率，因为如果按照1%的月收益率半年就可以获得500%。</p>

				<p>4、得出一个根据买入价和手续费得出1%净收益的卖出价的一个公式函数。</p>
				<p>5、尽快得出一个月的正常情况下的22天中的目标收益率的占比，进行至少12个月的模拟测试得出数据。在得出了月内目标收益率的占比后，需要根据占比重新计算日净收益率，始终确保月净收益率为22%。</p>

				<p>举例：如果一个月按照正常的22天计算，月目标收益占比为70%，那么如收益率则需要达到1.3%。公式：for(var a=10000,x=0.013,i=1;i<=12*(22*(0.7));i++){ a=a+a*x;console.log(a,a*x) }</p>

				<p>6、交易采用当天下午收盘时卖，然后根据情况再立即买。在现实操作中可以在休息是看盘到达预计净收益即可卖出，在此一定要确保，每天都在进行买入和卖出的操作。因此不管是早上卖出和买入都是可以的。</p>

				<p>7、真实情况下，对每天的收益额，每月的收益额，以及对应的收益率进行记录，包括总金额。公司可以自己做，为了以目标为导向有一个明确的系统。只要确保在计划的时间点完成了目标即可，要求不多不少。</p>
			</div> -->

		</div>

		<script type="text/javascript">

			/*

			需要的数据包括：
				
				记录数据：
					交易历史数据，
					日期变化数据，

				动态数据：
					总金额值，
					总收亏值，
					当前价格值，

				动态数据集：
					价格变动值，
					购买数量值

				独立数据集
					委托控件数据值，
					卖出控件数据值，


			方法分类：

				委托类，
				交易类，
				统计类，
				日期类，
				记录类，


			*/

			new Vue({
				el: 'body',
				data: {
					startup: 1000,

					usable: 1000,
					income: 0,
					days: 1,

					market: {
						'code'	: '002469',
						'name'	: 'Chowns',
						'price'	: 8.58,
						'hold'	: 0
					},

					became: [],				// 每日金额变得
					business: [],			// 买入/卖出交易记录

					spend: 1,				// 过去天数

					price: 0,				// 单股的金额变动
					previous: 0,			// 单股的上次金额

					number: 1,				// 买入数量

					sold: null,
					offtake: 1,				// 卖出数量

					yield: '0%',			// 收益率
					trends: true,			// 趋势
					// harden: false,		// 涨停
					// limit: false,		// 跌停

					intercalate: false,

					imitate: 0,				// 模拟次数

					annualearnings: [],
					yields: [],

					entrust: null,			// 委托操作数据
					entrustPrice: 0,		// 委托价
					entrustNumber: 0,		// 委托数量
					entrustList: [],		// 委托列表

					myChart: null,

				},
				computed: {

					// 总金额
					total: function () {
						var result = this.usable,
							self = this;

						this.business.map(function( item ){
							if ( item.have ) {
								result += item.price * item.number;
							}
						});
						this.entrustList.map(function( item ){
							if ( item.status ) {
								result += item.sold.price * (item.offtake * 100);
							}
						});

						return result.toFixed(2); 
					},

					// 持仓数量
					existOwned: function () {
						return this.business.filter(function( item ){
							return item.have;
						}).length;
					},

					// 委托数量
					entrustOwned: function () {
						return this.entrustList.filter(function( item ){
							return item.status;
						}).length;
					},

					// 交易历史
					existHistory: function () {
						return this.business.filter(function( item ){
							return !item.have;
						}).length;
					},

					// 持仓上限
					toplimit: function () {
						return parseInt(this.usable / (this.market.price * 100));
					},

					// 计算收益率统计
					monthYield: function () {
						var self = this,
							arr = this.business.filter(function( item ){ return !item.have && item.type == 'S' }),
							length = parseInt(arr.length / 22);

						var standard = 0,
							temp = 0,
							sum;

						var	result = {
								dayIncomeRatio: '100%',		// 全部天数总盈利占比
								dayRateOfReturn: '100%',	// 全部天数总收益率
								month: [],
								year: [],
								standardizedrate: ''
							};

						// 年
						for ( var i=0; i<parseInt(arr.length / (22 * 12)); i++ ) {
							temp = 0;
							arr.slice(i*(22*12), i*(22*12)+(22*12)).map(function( item ){
								temp += (item.sell - item.price) / item.price * 100;
							});
							result.year.push((temp/22).toFixed(2) + '%');
						}

						// 月
						for ( var i=0; i<length; i++ ) {
							sum = 0;
							temp=0;
							arr.slice(i*22, i*22+22).map(function( item ){
								sum += (item.sell - item.price ) * item.number;
								temp += (item.sell - item.price) / item.price * 100;
							});
							if ( temp > 22 ) {
								standard += 1;
							}
							result.month.push({
								ratio: (temp/22).toFixed(2) + '%',
								value: parseInt(sum)
							});
						}

						// 日
						var incomeTotal = 0;
						var incomeDays = arr.filter(function( item ){
								incomeTotal += self.getIncomeYield( item.price, item.sell, item.number/100 );
								return item.sell > item.price;
							}).length;

						console.log(incomeTotal);

						if ( this.business.length ) {
							result.dayRateOfReturn = (incomeTotal / this.days).toFixed(2) + '%';
						}
						if ( arr.length ) {
							result.dayIncomeRatio = (incomeDays / arr.length * 100).toFixed(2) + '%';
						}

						// 月标准率
						if ( standard ) {
							result.standardizedrate = (standard / result.month.length * 100).toFixed(2) + '%';
						}

						return result;
					},

					// 盈利和亏损总金额
					totalProfitAndLoss: function () {
						var self = this,
							value = 0,
							result = {
								profit: 0,
								loss: 0
							};

						this.business.map(function( item ){
							if ( item.type == 'S' ) {
								value = self.getIncome( item.price, item.sell, item.number/100 );
								if ( value > 0 ) {
									result.profit += value;
								}
								else {
									result.loss += value;
								}
							}
						});

						return result;
					}

				},
				watch: {

					// 监听价格变动
					market: {
						handler: function () {
							var self = this;

							// 处理委托
							this.entrustList.map(function( item ){
								if ( item.status && item.sold.days < self.days && item.price <= self.market.price ) {
									self.sold = item.sold;
									self.offtake = item.offtake;
									self.setSoldEntrust(item);

									item.status = false;
								}
							});
						},
						deep: true

					},

					// 计算日收益率
					previous: function () {
						var self = this;
							yesterday = 0;

						this.became.map(function( item ){
							if ( item.days + 1 == self.days && yesterday == 0 ) {
								yesterday = item.price;
							}
						});

						this.yield = (( this.price - yesterday ) / this.price * 100).toFixed(2) + '%';
						this.trends = Number(this.price) > Number(yesterday);
						// this.harden = Number(this.price) > Number(this.previous);
						// this.limit = Number(this.price) < Number(this.previous);
					},

					// 监听盈利
					income: function () {

						// 更新当天的总金额
						this.became[0].income = this.income;

						// 统计资产
						this.updateCartogram();
					}
				},
				methods: {

					// 买入
					setBuy: function () {
						var number = (parseInt(this.number) || 0 ) * 100,
							money = number * this.market.price;

						if ( this.usable >= money && money ) {
							this.usable = Number((this.usable - money).toFixed(2));
							this.market.hold += number;
							this.setBuyLog(number);

							this.number = 1;
						}
					},

					// 卖出
					setSold: function () {
						var b = this.sold.price,
							s = this.market.price,
							n = this.offtake;

						var number = n * 100;

						this.income = Number((this.income + this.getIncome(b,s,n)).toFixed(2));
						this.usable = Number((this.usable + this.getIncome(b,s,n,true)).toFixed(2));

						// 如果平仓 
						if ( this.sold.number == number ) {
							this.sold.have = false;
						}

						// 减仓
						this.market.hold -= number;
						this.sold.number -= number;

						// 记录
						this.setSoldLog(b, s, n*100);

						// 初始化
						this.sold = null;
						this.offtake = 0;
					},

					// 卖出委托
					setSoldEntrust: function ( item ) {
						var b = item.sold.price,
							s = item.price,
							n = item.offtake;

						this.income = Number((this.income + this.getIncome(b,s,n)).toFixed(2));
						this.usable = Number((this.usable + this.getIncome(b,s,n,true)).toFixed(2));

						// 如果平仓 
						if ( item.sold.number == 0 ) {
							item.sold.have = false;
						}

						// 记录
						this.setSoldLog(b, s, n*100);
					},

					// 添加购买交易记录
					setBuyLog: function ( number ) {
						var isOpen = true,
							self = this;

						this.business.map(function( item ){
							if ( item.price == self.market.price && item.days == self.days && item.type == 'B' ) {
								item.number += number;
								isOpen = false;
							}
						});

						// 是否开仓
						if ( isOpen ) {
							this.business.push({
								'type'	: 'B',
								'key'	: new Date().getTime().toString(16),
								'have'	: true,
								'number': number,
								'price'	: this.market.price,
								'sell'	: 0,
								'days'	: this.days
							});
						}
					},

					// 添加卖出记录
					setSoldLog: function ( buyPrice, soldPrice, soldNumber ) {
						var isNew = true,
							self = this;

						this.business.map(function( item ){
							if ( item.days == self.days && item.type == 'S' ) {
								item.number += soldNumber;
								isNew = false;
							}
						});

						if ( isNew ) {
							this.business.push({
								'type'	: 'S',
								'key'	: new Date().getTime().toString(16),
								'have'	: false,
								'number': soldNumber,
								'price'	: buyPrice,
								'sell'	: soldPrice,
								'days'	: this.days
							});
						}
					},

					// 收盘定价
					setToday: function () {
						var self = this,
							price = Number(this.price);

						this.previous = this.market.price;

						this.days += this.spend;
						this.market.price = price;

						var isAdd = true;

						this.became.map(function( item ){
							if ( item.days == self.days ) {
								item.price = price;
								isAdd = false;
							}
						});

						if ( isAdd ) {
							this.became.unshift({
								'days'	: this.days,
								'price'	: this.market.price,
								'total'	: this.total,
								'income': this.income
							});
						}

						// 统计资产
						this.updateCartogram();
					},

					// 获取当前持有的收益率（不计手续费）
					getYield : function ( item ) {
						return ((this.market.price - item.price) * item.price).toFixed(2) + '%';
					},

					//获取当前持有的收益（不计手续费）
					getProfit: function ( item ) {
						return parseInt((this.market.price - item.price) * item.number);
					},

					// 获取单笔交易的收益率（不计手续费）
					getSingleYield : function ( item, sell ) {
						return ((item.sell - item.price) * item.price).toFixed(2) + '%';
					},

					// 获取单笔交易的收益（不计手续费）
					getSingleProfit: function ( item ) {
						return parseInt((item.sell - item.price) * item.number);
					},

					// 获取单笔委托的收益率（不计手续费）
					getEntrustYield: function ( item ) {
						return ((item.price - item.sold.price) / item.sold.price * 100).toFixed(2) + '%';
					},

					// 获取单笔委托的收益（不计手续费）
					getEntrustProfit: function ( item ) {
						return ((item.price - item.sold.price) * item.offtake * 100).toFixed(2);
					},

					// 获取单笔净收益率（过滤手续费）
					getCleanYield: function ( item ) {
						return this.getIncome(item.price, item.sell, item.number/100);
					},

					// 获取单笔净收益（过滤手续费）
					getCleanProfit: function ( item ) {
						return this.getIncomeYield(item.price, item.sell, item.number/100);
					},

					// 加庄 减庄
					setAddPrice: function () {
						this.price = (Number(this.price) + 0.01).toFixed(2);
					},
					setSubPrice: function () {
						this.price = (Number(this.price) - 0.01).toFixed(2);
					},

					// 加仓 减仓
					setAddHold: function () {
						this.number = Number(this.number) + 1 > parseInt(this.usable / (this.market.price * 100)) ? Number(this.number) : Number(this.number) + 1;
					},
					setSubHold: function () {
						this.number = Number(this.number) - 1 < 0 ? 0 : Number(this.number) - 1;
					},

					// 加减 卖出 
					setAddOfftake: function () {
						this.offtake = Number(this.offtake) + 1 > this.sold.number / 100 ? this.offtake : Number(this.offtake) + 1;
					},
					setSubOfftake: function () {
						this.offtake = Number(this.offtake) - 1 < 0 ? 0 : Number(this.offtake) - 1;
					},

					// 加减 托管价 
					setAddEntrustPrice: function () {
						this.entrustPrice = (Number(this.entrustPrice) + 0.01).toFixed(2);
					},
					setSubEntrustPrice: function () {
						this.entrustPrice = (Number(this.entrustPrice) - 0.01).toFixed(2);
					},

					// 加减 托管数量
					setAddEntrustNumber: function () {
						this.entrustNumber = Number(this.entrustNumber) + 1 > this.entrust.number / 100 ? this.entrustNumber : Number(this.entrustNumber) + 1;
					},
					setSubEntrustNumber: function () {
						this.entrustNumber = Number(this.entrustNumber) - 1 < 0 ? 0 : Number(this.entrustNumber) - 1;
					},


					// 持续
					setLastStart: function ( key ) {
						var self = this;

						clearTimeout(window.t);
						window.t = setTimeout(function(){
							self.setLastStart(key);
							if ( self[key] ) {
								self[key]();
							}
						}, window.t ? 150 : 500);
					},
					setLastEnd: function () {
						clearTimeout(window.t);
					},

					// 获取净收益总额（去除手续费）
					getIncome: function ( b, s, n, t ) {
						if ( n === true ) {
							t = n; n = 1
						};
						return Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );
					},

					// 获取净收益率（去除手续费）
					getIncomeYield: function ( b, s, n, t ) {
						if ( n === true ) {
							t = n; n = 1
						};
						var income = Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );

						return Number((income / (b*n*100) * 100).toFixed(2));
					},

					// 获取两位小数
					getFixed: function ( value ) {
						return Number(value || 0).toFixed(2);
					},

					// 取整数
					getInt: function ( value ) {
						return parseInt(value) || 0;
					},

					// 模拟交易
					setImitate: function () {
						var change = parseInt(Math.random()*100)+1 <= 70,			// 几率
							random = Number(Number( (Math.random()*10).toFixed(2) / 100 )).toFixed(2);

						random = 0.001 + (parseInt((Math.random()*24)) / 1000);

						var value = Number(this.price * random) || 0;

						// 价格
						if ( change ) {
							this.price = (Number(this.price) + value).toFixed(2);
						}
						else {
							this.price = (Number(this.price) - value).toFixed(2);
						}
						this.setToday();

						// 卖出
						if ( this.existOwned ) {
							for ( var i=0, item; item = this.business[i]; i++ ) {
								if ( item.have ) {
									this.offtake = item.number / 100;
									this.sold = item;
									break;
								}
							}
							if ( this.sold ) {
								this.setSold();
							}
						}

						// 存入
						if ( this.business % 22 == 0 ) {
							this.usable += 1000;
						}

						if ( this.imitate < 5 ) {	// 22 * 12

							// 买入
							this.number = this.toplimit;
							this.setBuy();

							this.imitate += 1;
							setTimeout(this.setImitate, 1000);
						}
						else {
							// var self = this;
							// window.annualearnings = this.annualearnings.push(this.usable + this.income);
							// setTimeout(function(){
							// 	self.usable = 10000;
							// 	self.income = 0;
							// 	self.price = 8.58;
							// 	self.business = [];
							// 	self.became = [];
							// 	self.spend = 1;
							// 	self.number = 1;
							// 	self.offtake = 1;
							// 	self.days = 1;
							// 	self.imitate = 0
							// 	self.setImitate();
							// }, 3000);
						}
					},

					// 打开卖出界面
					getSold: function ( item ) {
						this.entrust = null;

						if ( this.sold == null ) {
							this.sold = item;
							this.offtake = item.number /100;
						}
						else {
							this.sold = null;	
						}
					},

					// 打开委托界面
					getEntrust: function ( item ) {
						this.sold = null;

						if ( this.entrust == null ) {
							this.entrust = item;
							this.entrustPrice = this.getSuggestedPrice(item);
							this.entrustNumber = item.number /100;
						}
						else {
							this.entrust = null;
						}
					},

					// 获取建议价
					getSuggestedPrice: function ( item ) {
						return (item.price + item.price * 0.014).toFixed(2);
					},

					// 获取建议差价点数
					getSuggestedPoints: function ( item ) {
						return parseInt(item.price * 0.014 * 100);
					},

					// 设置建议差价点数
					setSuggestedPoints: function ( item, value ) {
						var result = this.getSuggestedPoints(item) * ( value || 1 ) / 100;
						this.entrustPrice = (Number(item.price) + result).toFixed(2);
					},

					// 设置委托
					setEntrust: function () {
						var self = this;
						var exitsEntrust = true;

						this.entrustList.map(function( item ){
							if ( item.price == self.entrustPrice ) {
								item.offtake += parseInt(self.entrustNumber);
								item.status = true;
								exitsEntrust = false;
							}
						});

						if ( exitsEntrust ) {
							this.entrustList.push({
								price: this.entrustPrice,
								offtake: this.entrustNumber,
								sold: this.entrust,
								status: true
							});
						}

						this.entrust.number -= this.entrustNumber * 100;
						this.entrust = null;
					},

					// 取消委托
					setCancelEntrust: function ( item ) {
						item.sold.number += item.offtake * 100;
						item.sold.have = true;
						item.offtake = 0;
						item.status = false;
					},

					// 显示统计图
					setCartogram: function () {
						var self = this;

						// 基于准备好的dom，初始化echarts实例
						this.myChart = echarts.init(document.getElementById('echartsEl'));

						$(window).resize(function(){
							clearTimeout(window.c);
							window.c=setTimeout(function(){
								self.setCartogram();
								self.updateCartogram();
							}, 500);
						});

						// 指定图表的配置项和数据
						var option = {
								title: {
									text: ''
								},
								tooltip: {},
								legend: {
									show: false,
									data: ['Total']
								},
								xAxis: {
									data: []
								},
								yAxis: {},
								series: [{
									name: 'Total',
									type: 'line',
									data: []
								}]
							};

						// 使用刚指定的配置项和数据显示图表。
						this.myChart.setOption(option);
					},

					// 更新资产统计图
					updateCartogram: function () {
						var keys = [1],
							values = [0],
							data = Object.assign([], this.became).reverse();

						var self = this;

						data.map(function( item ){
							keys.push(item.days);
							values.push(item.income);
						});

						this.myChart.setOption({
							xAxis: {
								data: keys
							},
							series: [{
								name: 'Total',
								data: values
							}]
						});
					}
				},
				ready: function () {
					this.price = this.market.price;
					this.previous = this.market.price;

					this.setCartogram();
					this.updateCartogram();
					// this.setImitate();
				}
			});


			

			// 获取收益
			// var income = function ( b=1, s=10, n=1, t=false ) {
			// 		if ( n === true ) {
			// 			t = n; n = 1
			// 		};
			// 		return Number(((( s - b ) * 100 * n ) - ( s * 100 * n * 0.001 ) - (Math.max(b * 0.002, 5)) - (Math.max(b * 0.002, 5))).toFixed(2)) + ( t ? ( b * 100 * n ) : 0 );
			// 	};
			// var value = 10000;
			// for ( var i =0; i<12; i++ ) {
			// 	console.log( (i+1) + '月-----------------------');
			// 	console.log( '本金：' + value, '收益：' + parseInt(value*0.3), '总金额：' + (value += parseInt(value * 0.3)) );
			// }

			// 日净收益为1%，每月净收益22%，计算出年净收益率：1000%。
			// for(var a=10000,x=0.22,i=1;i<=12;i++){ a=a+a*x }

		</script>
	</body>
</html>